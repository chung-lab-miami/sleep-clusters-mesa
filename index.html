<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Clusters &amp; Mortality - MESA Cohort Analysis | Joon Chung, PhD</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f0f5f0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header { background: linear-gradient(135deg, #006400 0%, #228B22 50%, #2E8B57 100%); color: white; padding: 40px; text-align: center; }
        h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .subtitle { font-size: 1.2em; opacity: 0.95; font-weight: 300; }
        .subtitle a { color: #bbf7d0; text-decoration: none; }
        .subtitle a:hover { text-decoration: underline; }
        .author-info { margin-top: 15px; font-size: 0.95em; opacity: 0.85; }
        .toc { background-color: #f0fdf4; padding: 30px 40px; border-bottom: 3px solid #228B22; }
        .toc h2 { font-size: 1.8em; margin-bottom: 20px; color: #006400; }
        .toc ul { list-style: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
        .toc li { padding: 8px 0; }
        .toc a { color: #228B22; text-decoration: none; font-weight: 500; transition: color 0.3s ease; }
        .toc a:hover { color: #006400; text-decoration: underline; }
        .toc .section-number { display: inline-block; width: 28px; color: #006400; font-weight: 700; }
        .content { padding: 40px; }
        .section-title { font-size: 1.8em; color: #006400; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #bbf7d0; }
        .executive-summary { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #228B22; border-radius: 10px; padding: 30px; margin-bottom: 35px; }
        .executive-summary h3 { color: #006400; font-size: 1.4em; margin-bottom: 15px; }
        .executive-summary p, .executive-summary li { color: #14532d; }
        .key-finding-box { background: linear-gradient(135deg, #006400 0%, #228B22 100%); color: white; padding: 20px 25px; border-radius: 8px; margin: 20px 0; text-align: center; }
        .key-finding-box .finding-label { font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; opacity: 0.85; margin-bottom: 5px; }
        .key-finding-box .finding-value { font-size: 2.2em; font-weight: 800; }
        .key-finding-box .finding-detail { font-size: 0.95em; opacity: 0.9; margin-top: 5px; }
        .script-card { background: white; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 25px; overflow: hidden; transition: box-shadow 0.3s ease; }
        .script-card:hover { box-shadow: 0 4px 15px rgba(34, 139, 34, 0.15); }
        .script-card-header { background: linear-gradient(135deg, #006400 0%, #228B22 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .script-card-header h4 { font-size: 1.1em; font-weight: 600; }
        .script-meta { display: flex; gap: 15px; font-size: 0.85em; opacity: 0.9; }
        .script-card-body { padding: 20px; }
        .script-purpose { font-weight: 600; color: #006400; margin-bottom: 10px; font-size: 1.05em; }
        .script-details { margin-left: 15px; }
        .script-details li { margin-bottom: 6px; color: #4b5563; }
        .script-result { background-color: #f0fdf4; border-left: 4px solid #228B22; padding: 10px 15px; margin-top: 12px; font-style: italic; color: #14532d; }
        .dir-label { background: linear-gradient(90deg, #006400, #228B22); color: white; padding: 12px 20px; font-size: 1.3em; font-weight: 700; margin-top: 30px; margin-bottom: 20px; border-radius: 8px; letter-spacing: 0.5px; }
        code { background-color: #f0fdf4; color: #006400; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 0.9em; }
        pre { background-color: #14532d; color: #bbf7d0; padding: 20px; border-radius: 8px; overflow-x: auto; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 0.85em; line-height: 1.5; margin: 15px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.95em; }
        th { background: linear-gradient(135deg, #006400 0%, #228B22 100%); color: white; padding: 12px 15px; text-align: left; font-weight: 600; }
        td { padding: 10px 15px; border-bottom: 1px solid #e5e7eb; }
        tr:nth-child(even) { background-color: #f0fdf4; }
        tr:hover { background-color: #dcfce7; }
        .info-box { padding: 15px 20px; border-radius: 8px; margin: 15px 0; }
        .info-box.green { background-color: #f0fdf4; border-left: 4px solid #228B22; }
        .info-box.amber { background-color: #fefce8; border-left: 4px solid #eab308; }
        .info-box.red { background-color: #fef2f2; border-left: 4px solid #dc2626; }
        .info-box.blue { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
        .info-box-title { font-weight: 700; margin-bottom: 6px; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-pill { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; border-radius: 10px; padding: 15px; text-align: center; }
        .stat-pill .stat-label { font-size: 0.8em; color: #14532d; text-transform: uppercase; letter-spacing: 1px; }
        .stat-pill .stat-value { font-size: 1.8em; font-weight: 800; color: #006400; margin: 5px 0; }
        .stat-pill .stat-note { font-size: 0.8em; color: #4b5563; }
        .data-flow { background-color: #14532d; color: #bbf7d0; padding: 25px; border-radius: 10px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 0.82em; line-height: 1.7; overflow-x: auto; }
        .data-flow .flow-arrow { color: #4ade80; font-weight: bold; }
        .data-flow .flow-file { color: #86efac; }
        .data-flow .flow-data { color: #fbbf24; }
        .data-flow .flow-comment { color: #6b7280; font-style: italic; }
        .issue-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px 20px; margin: 10px 0; }
        .issue-card.severity-high { border-left: 4px solid #dc2626; }
        .issue-card.severity-medium { border-left: 4px solid #eab308; }
        .issue-card.severity-low { border-left: 4px solid #3b82f6; }
        .issue-severity { font-size: 0.75em; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-bottom: 8px; }
        .severity-high .issue-severity { background-color: #fef2f2; color: #dc2626; }
        .severity-medium .issue-severity { background-color: #fefce8; color: #eab308; }
        .severity-low .issue-severity { background-color: #eff6ff; color: #3b82f6; }
        .issue-title { font-weight: 600; margin-bottom: 6px; }
        .issue-location { font-size: 0.85em; color: #6b7280; font-family: monospace; }
        .forest-row { display: grid; grid-template-columns: 250px 1fr 120px; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .forest-row.header { font-weight: 700; border-bottom: 2px solid #006400; color: #006400; }
        .forest-label { font-size: 0.9em; padding-right: 10px; }
        .forest-plot-area { position: relative; height: 20px; }
        .forest-ref-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background-color: #9ca3af; }
        .forest-ci-line { position: absolute; height: 2px; background-color: #006400; top: 50%; transform: translateY(-50%); }
        .forest-point { position: absolute; width: 10px; height: 10px; border-radius: 50%; background-color: #006400; top: 50%; transform: translate(-50%, -50%); }
        .forest-hr-text { font-size: 0.85em; font-family: monospace; text-align: right; }
        .section-sep { height: 4px; background: linear-gradient(90deg, #006400, #228B22, #2E8B57, #228B22, #006400); margin: 40px 0; border-radius: 2px; }
        footer { background: linear-gradient(135deg, #006400 0%, #14532d 100%); color: white; padding: 25px 40px; text-align: center; font-size: 0.9em; }
        footer a { color: #86efac; }
        .model-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; margin-right: 5px; }
        .model-tag.primary { background-color: #dcfce7; color: #006400; }
        .model-tag.sensitivity { background-color: #fef3c7; color: #92400e; }
        .model-tag.psm { background-color: #dbeafe; color: #1e40af; }
        .sig { color: #006400; font-weight: 700; }
        .nonsig { color: #9ca3af; }

        /* Skills grid */
        .skills-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin: 25px 0; }
        .skill-card { background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 20px; transition: box-shadow 0.3s ease; }
        .skill-card:hover { box-shadow: 0 4px 15px rgba(34, 139, 34, 0.15); }
        .skill-card-icon { font-size: 1.5em; margin-bottom: 8px; }
        .skill-card h4 { color: #006400; font-size: 1.1em; margin-bottom: 8px; }
        .skill-card p { color: #4b5563; font-size: 0.92em; }
        .skill-card .skill-tags { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px; }
        .skill-tag { background-color: #f0fdf4; color: #006400; padding: 3px 10px; border-radius: 12px; font-size: 0.78em; font-weight: 600; border: 1px solid #bbf7d0; }

        /* TLDR banner */
        .tldr-banner { background: linear-gradient(135deg, #14532d 0%, #006400 100%); color: white; border-radius: 12px; padding: 30px; margin-bottom: 30px; }
        .tldr-banner h3 { font-size: 1.3em; margin-bottom: 12px; letter-spacing: 1px; }
        .tldr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .tldr-item { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 15px; }
        .tldr-item strong { display: block; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 4px; }
        .tldr-item span { font-size: 1.05em; }

        @media (max-width: 768px) { header { padding: 20px; } h1 { font-size: 1.8em; } .content { padding: 20px; } .toc ul { grid-template-columns: 1fr; } .stat-grid { grid-template-columns: repeat(2, 1fr); } .skills-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">

        <header>
            <h1>Sleep Clusters &amp; All-Cause Mortality</h1>
            <div class="subtitle">Unsupervised Learning, Causal Inference &amp; Survival Analysis in MESA (N = 1,759)</div>
            <div class="subtitle" style="font-size: 1.0em; margin-top: 5px;">
                17 R scripts | 2,500+ lines | 40+ Cox models | 5 propensity score specifications
            </div>
            <div class="author-info">
                <strong>Joon Chung, PhD</strong> | University of Miami, Miller School of Medicine<br>
                Originally conducted at Brigham and Women's Hospital / Harvard Medical School (2022)
            </div>
        </header>

        <nav class="toc">
            <h2>Table of Contents</h2>
            <ul>
                <li><a href="#tldr"><span class="section-number">1.</span> TL;DR</a></li>
                <li><a href="#skills"><span class="section-number">2.</span> Technical Skills Demonstrated</a></li>
                <li><a href="#results"><span class="section-number">3.</span> Key Results &amp; Forest Plot</a></li>
                <li><a href="#overview"><span class="section-number">4.</span> Project Overview &amp; Dataset</a></li>
                <li><a href="#dataflow"><span class="section-number">5.</span> Data Flow &amp; Architecture</a></li>
                <li><a href="#pipeline"><span class="section-number">6.</span> Pipeline Scripts (R code/)</a></li>
                <li><a href="#upstream"><span class="section-number">7.</span> Upstream Scripts (Upstream/)</a></li>
                <li><a href="#root"><span class="section-number">8.</span> Root Scripts</a></li>
                <li><a href="#methods"><span class="section-number">9.</span> Statistical Methods Inventory</a></li>
                <li><a href="#packages"><span class="section-number">10.</span> R Package Dependencies</a></li>
                <li><a href="#issues"><span class="section-number">11.</span> Code Review: Issues &amp; Recommendations</a></li>
            </ul>
        </nav>

        <div class="content">

            <!-- 1. TLDR -->
            <section id="tldr">
                <h2 class="section-title">1. TL;DR</h2>

                <div class="tldr-banner">
                    <h3>THE QUESTION</h3>
                    <p style="font-size: 1.1em; margin-bottom: 20px;">Can unsupervised clustering of wearable sleep data predict who will die over the next 7 years -- better than any single sleep metric alone?</p>

                    <div class="tldr-grid">
                        <div class="tldr-item">
                            <strong>Data</strong>
                            <span>1,759 adults with 7-day wrist actigraphy, PSG, questionnaires, and 7-year mortality follow-up (MESA cohort)</span>
                        </div>
                        <div class="tldr-item">
                            <strong>Method</strong>
                            <span>Sparse k-means clustering on 3 actigraphy features, validated by 4 independent methods, then tested via Cox regression, propensity score matching, and IPTW</span>
                        </div>
                        <div class="tldr-item">
                            <strong>Result</strong>
                            <span>The "Regular-optimal" sleep cluster had <strong>48% lower mortality</strong> (HR 0.52 [0.38, 0.72]) -- outperforming every individual metric</span>
                        </div>
                        <div class="tldr-item">
                            <strong>Robustness</strong>
                            <span>Consistent across 40+ model specifications, 5 PS matching designs, age-as-time-metric, and reverse-causation sensitivity analyses</span>
                        </div>
                    </div>
                </div>

                <div class="key-finding-box">
                    <div class="finding-label">Primary Finding</div>
                    <div class="finding-value">HR 0.52 [0.38, 0.72]</div>
                    <div class="finding-detail">Favorable sleep cluster associated with 48% lower all-cause mortality risk</div>
                    <div class="finding-detail" style="margin-top: 8px; font-size: 0.85em;">Robust across progressive adjustment (HR 0.58-0.61), propensity score matching (HR 0.52-0.63), and multiple sensitivity analyses</div>
                </div>

                <div class="stat-grid">
                    <div class="stat-pill">
                        <div class="stat-label">Analytic N</div>
                        <div class="stat-value">1,759</div>
                        <div class="stat-note">Complete cases</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">Deaths</div>
                        <div class="stat-value">176</div>
                        <div class="stat-note">All-cause mortality</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">R Scripts</div>
                        <div class="stat-value">17</div>
                        <div class="stat-note">3 directories</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">Cox Models</div>
                        <div class="stat-value">40+</div>
                        <div class="stat-note">Primary + sensitivity</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">PS Matched</div>
                        <div class="stat-value">5</div>
                        <div class="stat-note">Covariate specifications</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">Cluster HR Range</div>
                        <div class="stat-value">0.52-0.61</div>
                        <div class="stat-note">Primary models</div>
                    </div>
                </div>
            </section>

            <div class="section-sep"></div>

            <!-- 2. TECHNICAL SKILLS -->
            <section id="skills">
                <h2 class="section-title">2. Technical Skills Demonstrated</h2>

                <div class="skills-grid">
                    <div class="skill-card">
                        <div class="skill-card-icon">&#x1F50D;</div>
                        <h4>Unsupervised Learning &amp; Cluster Validation</h4>
                        <p>Sparse k-means clustering on wearable sensor features with rigorous validation: gap statistic (60 bootstrap), NbClust (30 indices), cStability (1,000 bootstrap), and Jaccard bootstrap -- all converging on k=2. Feature-weighted clustering via <code>sparcl</code> automatically identifies the most discriminative sleep dimensions.</p>
                        <div class="skill-tags">
                            <span class="skill-tag">K-Means</span>
                            <span class="skill-tag">Sparse Clustering</span>
                            <span class="skill-tag">Model Selection</span>
                            <span class="skill-tag">Bootstrap Validation</span>
                        </div>
                    </div>

                    <div class="skill-card">
                        <div class="skill-card-icon">&#x2696;</div>
                        <h4>Causal Inference &amp; Propensity Score Methods</h4>
                        <p>Five incrementally specified propensity score models with full matching, probit link, ATE estimand, and IPTW weighting. Balance diagnostics via Love plots (SMD &lt; 0.1). Bootstrap CIs (R=999) for robust uncertainty quantification. Doubly-robust estimation combining matching with covariate adjustment.</p>
                        <div class="skill-tags">
                            <span class="skill-tag">Propensity Score Matching</span>
                            <span class="skill-tag">IPTW</span>
                            <span class="skill-tag">DAG-Based Adjustment</span>
                            <span class="skill-tag">Causal Inference</span>
                        </div>
                    </div>

                    <div class="skill-card">
                        <div class="skill-card-icon">&#x1F4C9;</div>
                        <h4>Survival Analysis &amp; Time-to-Event Modeling</h4>
                        <p>40+ Cox proportional hazards models with progressive DAG-informed confounder adjustment. Sensitivity analyses: age as time metric, reverse-causation exclusion, penalized splines for nonlinear confounding, and no-prevalent-disease subsample. Kaplan-Meier and covariate-adjusted survival curves.</p>
                        <div class="skill-tags">
                            <span class="skill-tag">Cox Regression</span>
                            <span class="skill-tag">Kaplan-Meier</span>
                            <span class="skill-tag">Sensitivity Analysis</span>
                            <span class="skill-tag">Penalized Splines</span>
                        </div>
                    </div>

                    <div class="skill-card">
                        <div class="skill-card-icon">&#x1F527;</div>
                        <h4>Data Engineering &amp; Feature Construction</h4>
                        <p>Multi-source data integration: 8 Stata datasets merged by participant ID. Engineered 30+ features from raw actigraphy, PSG, and questionnaire data. Built AEHI-10 dietary composite (10 sex-specific component scores). Circular variable coding for sleep timing. Log-transforms for skewed distributions.</p>
                        <div class="skill-tags">
                            <span class="skill-tag">ETL Pipelines</span>
                            <span class="skill-tag">Feature Engineering</span>
                            <span class="skill-tag">Data Merging</span>
                            <span class="skill-tag">Domain Expertise</span>
                        </div>
                    </div>

                    <div class="skill-card">
                        <div class="skill-card-icon">&#x1F4CA;</div>
                        <h4>Dimensionality Reduction &amp; Composite Scoring</h4>
                        <p>PCA on 13 sleep health metrics to derive a continuous composite score (PC1). 13-item binary Sleep Health Score (SHS). Both approaches independently validated against mortality. Eigenvalue analysis, scree plots, and variable contribution visualization.</p>
                        <div class="skill-tags">
                            <span class="skill-tag">PCA</span>
                            <span class="skill-tag">Composite Scores</span>
                            <span class="skill-tag">Dimension Reduction</span>
                        </div>
                    </div>

                    <div class="skill-card">
                        <div class="skill-card-icon">&#x1F3AF;</div>
                        <h4>Methodological Rigor &amp; Reproducibility</h4>
                        <p>Triangulation across methods: standard regression, PSM, IPTW, PCA, and cluster analysis all address the same question from different angles. Reproducible seeds (<code>set.seed(8675309)</code>). Modular 8-script pipeline with clear data lineage. Publication-quality visualizations.</p>
                        <div class="skill-tags">
                            <span class="skill-tag">Reproducibility</span>
                            <span class="skill-tag">Triangulation</span>
                            <span class="skill-tag">Pipeline Design</span>
                            <span class="skill-tag">ggplot2</span>
                        </div>
                    </div>
                </div>
            </section>

            <div class="section-sep"></div>

            <!-- 3. KEY RESULTS & FOREST PLOT -->
            <section id="results">
                <h2 class="section-title">3. Key Results</h2>

                <h3 style="color: #006400; margin: 20px 0 10px;">Cluster vs Individual Metrics (Head-to-Head)</h3>
                <p style="margin-bottom: 15px; color: #4b5563;">The multivariate cluster consistently outperformed every individual sleep metric -- demonstrating that the joint distribution of sleep features captures mortality risk that single metrics miss.</p>
                <table>
                    <tr><th>Predictor</th><th>Definition</th><th>HR [95% CI]</th><th>Interpretation</th></tr>
                    <tr><td><strong>Sleep Cluster (Favorable)</strong></td><td>Sparse K-means cluster</td><td><strong class="sig">0.52 [0.38, 0.72]</strong></td><td>48% lower mortality -- strongest predictor</td></tr>
                    <tr><td>Duration SD &lt;60 min</td><td>SDTST regularity</td><td class="sig">0.61 [0.44, 0.84]</td><td>39% lower mortality</td></tr>
                    <tr><td>Midpoint SD &lt;30 min</td><td>MPSD timing regularity</td><td class="sig">0.64 [0.44, 0.94]</td><td>36% lower mortality</td></tr>
                    <tr><td>TST 6-8 hours</td><td>Optimal sleep duration</td><td class="sig">0.73 [0.54, 0.99]</td><td>27% lower mortality</td></tr>
                </table>

                <h3 style="color: #006400; margin: 30px 0 10px;">Visual Summary: Hazard Ratios Across All Model Specifications</h3>

                <div style="background: #f9fafb; border-radius: 10px; padding: 25px; margin: 15px 0;">
                    <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 15px; text-align: center;">
                        Hazard Ratios for Favorable Sleep Cluster (reference: Unfavorable) | Dashed line = null (HR = 1.0)
                    </div>
                    <div class="forest-row header"><div class="forest-label">Model Specification</div><div style="display: flex; justify-content: space-between; font-size: 0.8em;"><span>0.3</span><span>0.5</span><span>0.7</span><span>1.0</span><span>1.2</span></div><div class="forest-hr-text">HR [95% CI]</div></div>

                    <div style="font-weight: 700; color: #006400; padding: 10px 0 5px; border-bottom: 1px solid #d1d5db; font-size: 0.95em;">Primary Cox Models</div>
                    <div class="forest-row"><div class="forest-label">Model 1: Sociodemographics</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 14.4%; width: 40.0%;"></div><div class="forest-point" style="left: 32.2%;"></div></div><div class="forest-hr-text"><strong>0.59</strong> [0.43, 0.79]</div></div>
                    <div class="forest-row"><div class="forest-label">Model 2: + Lifestyle</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 14.4%; width: 40.0%;"></div><div class="forest-point" style="left: 31.1%;"></div></div><div class="forest-hr-text"><strong>0.58</strong> [0.43, 0.79]</div></div>
                    <div class="forest-row"><div class="forest-label">Model 3: + Comorbidity</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 14.4%; width: 41.1%;"></div><div class="forest-point" style="left: 31.1%;"></div></div><div class="forest-hr-text"><strong>0.58</strong> [0.43, 0.80]</div></div>
                    <div class="forest-row"><div class="forest-label">Model 4: + Sleep disorders</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 16.7%; width: 42.2%;"></div><div class="forest-point" style="left: 34.4%;"></div></div><div class="forest-hr-text"><strong>0.61</strong> [0.45, 0.83]</div></div>

                    <div style="font-weight: 700; color: #006400; padding: 10px 0 5px; border-bottom: 1px solid #d1d5db; font-size: 0.95em;">Propensity Score Matched</div>
                    <div class="forest-row"><div class="forest-label">PS Model 2: Lifestyle</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 7.8%; width: 38.9%;"></div><div class="forest-point" style="left: 24.4%;"></div></div><div class="forest-hr-text"><strong>0.52</strong> [0.37, 0.72]</div></div>
                    <div class="forest-row"><div class="forest-label">PS Model 4: Sleep disorders</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 8.9%; width: 42.2%;"></div><div class="forest-point" style="left: 26.7%;"></div></div><div class="forest-hr-text"><strong>0.54</strong> [0.38, 0.76]</div></div>
                    <div class="forest-row"><div class="forest-label">PS Model 5: Kitchen sink</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 8.9%; width: 42.2%;"></div><div class="forest-point" style="left: 26.7%;"></div></div><div class="forest-hr-text"><strong>0.54</strong> [0.38, 0.76]</div></div>

                    <div style="font-weight: 700; color: #006400; padding: 10px 0 5px; border-bottom: 1px solid #d1d5db; font-size: 0.95em;">Sensitivity Analyses</div>
                    <div class="forest-row"><div class="forest-label">Age as time metric (M2)</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 22.2%; width: 48.9%;"></div><div class="forest-point" style="left: 43.3%;"></div></div><div class="forest-hr-text"><strong>0.69</strong> [0.50, 0.94]</div></div>
                    <div class="forest-row"><div class="forest-label">Excl. deaths &lt;1yr (M3)</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 15.6%; width: 46.7%;"></div><div class="forest-point" style="left: 35.6%;"></div></div><div class="forest-hr-text"><strong>0.62</strong> [0.44, 0.86]</div></div>

                    <div style="font-weight: 700; color: #006400; padding: 10px 0 5px; border-bottom: 1px solid #d1d5db; font-size: 0.95em;">Individual Metrics (for comparison)</div>
                    <div class="forest-row"><div class="forest-label" style="color: #6b7280;">MPSD &lt;30 min</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 15.6%; width: 55.6%; background: #9ca3af;"></div><div class="forest-point" style="left: 37.8%; background: #9ca3af;"></div></div><div class="forest-hr-text" style="color: #6b7280;">0.64 [0.44, 0.94]</div></div>
                    <div class="forest-row"><div class="forest-label" style="color: #6b7280;">SDTST &lt;60 min</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 15.6%; width: 44.4%; background: #9ca3af;"></div><div class="forest-point" style="left: 34.4%; background: #9ca3af;"></div></div><div class="forest-hr-text" style="color: #6b7280;">0.61 [0.44, 0.84]</div></div>
                    <div class="forest-row"><div class="forest-label" style="color: #6b7280;">TST 6-8 hrs</div><div class="forest-plot-area"><div class="forest-ref-line" style="left: 77.8%;"></div><div class="forest-ci-line" style="left: 26.7%; width: 50.0%; background: #9ca3af;"></div><div class="forest-point" style="left: 47.8%; background: #9ca3af;"></div></div><div class="forest-hr-text" style="color: #6b7280;">0.73 [0.54, 0.99]</div></div>
                </div>

                <h3 style="color: #006400; margin: 30px 0 10px;">Full Results Tables</h3>

                <details style="margin-bottom: 15px;">
                    <summary style="cursor: pointer; color: #006400; font-weight: 600; padding: 10px; background: #f0fdf4; border-radius: 8px;">Primary Cox Models (Normal Time Scale) -- click to expand</summary>
                    <table>
                        <tr><th>Model</th><th>Adjustment</th><th>Cluster HR</th><th>MPSD HR</th><th>SDTST HR</th><th>TST HR</th></tr>
                        <tr><td>Model 1</td><td>Sociodemographics</td><td><strong class="sig">0.59 [0.43, 0.79]</strong></td><td class="sig">0.63 [0.43, 0.91]</td><td class="sig">0.69 [0.50, 0.95]</td><td class="sig">0.70 [0.52, 0.95]</td></tr>
                        <tr><td>Model 2</td><td>+ Lifestyle</td><td><strong class="sig">0.58 [0.43, 0.79]</strong></td><td class="sig">0.62 [0.43, 0.91]</td><td class="sig">0.70 [0.51, 0.97]</td><td class="sig">0.71 [0.53, 0.97]</td></tr>
                        <tr><td>Model 3</td><td>+ Medical comorbidity</td><td><strong class="sig">0.58 [0.43, 0.80]</strong></td><td class="sig">0.62 [0.43, 0.91]</td><td class="sig">0.70 [0.51, 0.97]</td><td class="sig">0.71 [0.52, 0.96]</td></tr>
                        <tr><td>Model 4</td><td>+ Sleep disorders</td><td><strong class="sig">0.61 [0.45, 0.83]</strong></td><td class="nonsig">0.67 [0.46, 0.98]</td><td class="nonsig">0.73 [0.53, 1.01]</td><td class="sig">0.72 [0.53, 0.98]</td></tr>
                    </table>
                </details>

                <details style="margin-bottom: 15px;">
                    <summary style="cursor: pointer; color: #006400; font-weight: 600; padding: 10px; background: #f0fdf4; border-radius: 8px;">Age as Time Metric (Sensitivity) -- click to expand</summary>
                    <table>
                        <tr><th>Model</th><th>Adjustment</th><th>Cluster HR</th><th>MPSD HR</th><th>SDTST HR</th><th>TST HR</th></tr>
                        <tr><td>Model 1</td><td>Sociodemographics</td><td><strong class="sig">0.72 [0.53, 0.99]</strong></td><td class="nonsig">0.76 [0.52, 1.11]</td><td class="nonsig">0.80 [0.58, 1.10]</td><td class="nonsig">0.83 [0.61, 1.12]</td></tr>
                        <tr><td>Model 2</td><td>+ Lifestyle</td><td><strong class="sig">0.69 [0.50, 0.94]</strong></td><td class="nonsig">0.70 [0.47, 1.02]</td><td class="nonsig">0.82 [0.59, 1.13]</td><td class="nonsig">0.86 [0.63, 1.16]</td></tr>
                        <tr><td>Model 3</td><td>+ Medical comorbidity</td><td><strong class="sig">0.70 [0.51, 0.96]</strong></td><td class="nonsig">0.68 [0.46, 1.01]</td><td class="nonsig">0.83 [0.60, 1.14]</td><td class="nonsig">0.87 [0.63, 1.18]</td></tr>
                        <tr><td>Model 4</td><td>+ Sleep disorders</td><td><strong class="nonsig">0.74 [0.54, 1.02]</strong></td><td class="nonsig">0.73 [0.49, 1.09]</td><td class="nonsig">0.87 [0.63, 1.20]</td><td class="nonsig">0.89 [0.65, 1.21]</td></tr>
                    </table>
                </details>

                <details style="margin-bottom: 15px;">
                    <summary style="cursor: pointer; color: #006400; font-weight: 600; padding: 10px; background: #f0fdf4; border-radius: 8px;">Propensity Score Matched &amp; Reverse Causation -- click to expand</summary>
                    <h4 style="color: #006400; margin: 15px 0 10px;">PS Matched Models</h4>
                    <table>
                        <tr><th>PS Model</th><th>Matching Covariates</th><th>Cluster HR [95% CI]</th></tr>
                        <tr><td>PS Model 1</td><td>Sociodemographics</td><td><strong class="sig">0.58 [0.41, 0.82]</strong></td></tr>
                        <tr><td>PS Model 2</td><td>+ Lifestyle</td><td><strong class="sig">0.52 [0.37, 0.72]</strong></td></tr>
                        <tr><td>PS Model 3</td><td>+ Medical comorbidity</td><td><strong class="sig">0.63 [0.43, 0.92]</strong></td></tr>
                        <tr><td>PS Model 4</td><td>+ Sleep disorders</td><td><strong class="sig">0.54 [0.38, 0.76]</strong></td></tr>
                        <tr><td>PS Model 5</td><td>Kitchen sink (+ HTN, DM)</td><td><strong class="sig">0.54 [0.38, 0.76]</strong></td></tr>
                    </table>
                    <h4 style="color: #006400; margin: 15px 0 10px;">Exclude Deaths Within 1 Year</h4>
                    <table>
                        <tr><th>Model</th><th>Adjustment</th><th>N (events)</th><th>Cluster HR [95% CI]</th></tr>
                        <tr><td>Model 0</td><td>Sociodemographics</td><td>1,740 (157)</td><td><strong class="sig">0.59 [0.43, 0.81]</strong></td></tr>
                        <tr><td>Model 1</td><td>+ Lifestyle</td><td>1,740 (157)</td><td><strong class="sig">0.57 [0.42, 0.80]</strong></td></tr>
                        <tr><td>Model 2</td><td>+ Medical comorbidity</td><td>1,740 (157)</td><td><strong class="sig">0.58 [0.42, 0.81]</strong></td></tr>
                        <tr><td>Model 3</td><td>+ Sleep disorders</td><td>1,740 (157)</td><td><strong class="sig">0.62 [0.44, 0.86]</strong></td></tr>
                        <tr><td>Age metric</td><td>Medical comorbidity</td><td>1,740 (157)</td><td><strong class="sig">0.71 [0.51, 0.99]</strong></td></tr>
                    </table>
                </details>
            </section>

            <div class="section-sep"></div>

            <!-- 4. PROJECT OVERVIEW -->
            <section id="overview">
                <h2 class="section-title">4. Project Overview &amp; Dataset</h2>

                <div class="info-box green">
                    <div class="info-box-title">MESA (Multi-Ethnic Study of Atherosclerosis)</div>
                    <p>A prospective cohort of 6,814 men and women aged 45-84 years, recruited 2000-2002 from 6 US sites. Sleep sub-study at Exam 5 (~2010-2012) included 7-day wrist actigraphy, in-lab polysomnography, and sleep questionnaires on ~2,000 participants.</p>
                </div>

                <h3 style="color: #006400; margin: 20px 0 10px;">Data Sources Merged</h3>
                <table>
                    <tr><th>Dataset</th><th>Contents</th><th>Key Variables</th></tr>
                    <tr><td><code>mesa_5</code> (Exam 5)</td><td>Demographics, anthropometrics, lifestyle</td><td>age5c, bmi5c, pamvcm5c, smkstat5, income5</td></tr>
                    <tr><td><code>mesa_psg</code></td><td>Polysomnography sleep architecture</td><td>ahi, sws_per, rem_per</td></tr>
                    <tr><td><code>mesa_act</code></td><td>7-day actigraphy summary stats</td><td>tst, mpsd, sdtst, sme, frag</td></tr>
                    <tr><td><code>mesa_sleepq</code></td><td>Sleep questionnaires (WHIIRS, ESS, restless legs)</td><td>whiirs5c, ess, rstlesslgs5, wrksched5</td></tr>
                    <tr><td><code>mesa_1</code> (Exam 1)</td><td>Baseline education</td><td>educ1 (degree attainment)</td></tr>
                    <tr><td><code>mesa_healthlife</code></td><td>CES-D depression scale</td><td>cesd5c, badslp5 (sleep item removed)</td></tr>
                    <tr><td><code>mesa_ffq5</code> / <code>mesa_nutrients5</code></td><td>Food Frequency Questionnaire &amp; nutrients</td><td>AEHI-10 dietary quality composite</td></tr>
                    <tr><td><code>mesa_all_events</code></td><td>Mortality and CVD events through 2018</td><td>dth, dthtt, cvdatt, cancertt, copdtt</td></tr>
                </table>

                <h3 style="color: #006400; margin: 20px 0 10px;">Cluster Assignment</h3>
                <div class="info-box blue">
                    <div class="info-box-title">Sparse K-Means: 2 Clusters (sparcl package)</div>
                    <p><strong>Cluster 1 - "Regular-Optimal" (N=1,046):</strong> Higher TST (~7 hrs), lower MPSD (&lt;30 min), lower SDTST (&lt;60 min)</p>
                    <p><strong>Cluster 2 - "Irregular-Insufficient" (N=783):</strong> Lower TST (&lt;6 hrs), higher MPSD (&gt;30 min), higher SDTST (&gt;60 min)</p>
                    <p style="margin-top: 8px;"><strong>Validation:</strong> Gap statistic, NbClust (30 indices), cStability (1,000 bootstrap), Jaccard bootstrap -- all converge on k=2</p>
                </div>
            </section>

            <div class="section-sep"></div>

            <!-- 5. DATA FLOW -->
            <section id="dataflow">
                <h2 class="section-title">5. Data Flow &amp; Architecture</h2>

                <div class="data-flow">
<span class="flow-comment">## ========== RAW DATA IMPORT (Script 01) ==========</span>

<span class="flow-file">MESAe5_FinalLabel.dta</span>  &#x2500;&#x2510;
<span class="flow-file">MESAe5_SleepPolysomn.dta</span>&#x2500;&#x2524;
<span class="flow-file">MESAe5_SleepActigraphy.dta</span>&#x2524;<span class="flow-arrow"> ──merge(by="idno")──▶ </span><span class="flow-data">mesa_df</span>
<span class="flow-file">MESAe5_SleepQ.dta</span>&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2524;                        <span class="flow-comment">(master merged frame)</span>
<span class="flow-file">MESAe1_FinalLabel.dta</span>&#x2500;&#x2500;&#x2500;&#x2500;&#x2518;<span class="flow-comment"> (education only)</span>

<span class="flow-comment">## ========== FEATURE ENGINEERING (Script 02) ==========</span>

<span class="flow-data">mesa_df</span> <span class="flow-arrow">──▶</span> Sparse K-means(tst, log_mpsd, sdtst) <span class="flow-arrow">──▶</span> <span class="flow-data">cluster_f</span> (783 vs 1,046)
       <span class="flow-arrow">──▶</span> PCA(13 sleep metrics * -1)        <span class="flow-arrow">──▶</span> <span class="flow-data">pc1_scaled</span>
       <span class="flow-arrow">──▶</span> Sum(13 dichotomized indicators)    <span class="flow-arrow">──▶</span> <span class="flow-data">shs</span> (0-13)
       <span class="flow-arrow">──▶</span> Dichotomize: <span class="flow-data">tst_di</span>, <span class="flow-data">mpsd_di</span>, <span class="flow-data">sdtst_di</span> + 10 more

<span class="flow-comment">## ========== DIET COMPOSITE (Script 03) ==========</span>

<span class="flow-file">MESAe5_FFQ.dta</span> + <span class="flow-file">MESAe5_Nutrient.dta</span> <span class="flow-arrow">──▶</span> 10 component scores <span class="flow-arrow">──▶</span> <span class="flow-data">aehi_df</span>

<span class="flow-comment">## ========== ANALYTIC DATASET (Script 04) ==========</span>

<span class="flow-data">mesa_subset_df</span> + <span class="flow-data">aehi_df</span> + <span class="flow-data">mesa_all_events</span> <span class="flow-arrow">──▶</span> <span class="flow-data">shs_df</span> (N = 1,726; 171 deaths)

<span class="flow-comment">## ========== ANALYSIS BRANCHES ==========</span>

<span class="flow-data">cluster_df</span> <span class="flow-arrow">──▶</span> Script 05: Cluster vs individual metrics <span class="flow-arrow">──▶</span> Forest plot
           <span class="flow-arrow">──▶</span> Script 06: KM + adjusted survival curves <span class="flow-arrow">──▶</span> 5 PNGs
           <span class="flow-arrow">──▶</span> Script 07: Propensity score matching <span class="flow-arrow">──▶</span> Love plots, matched Cox
           <span class="flow-arrow">──▶</span> Script 08: TableOne descriptives <span class="flow-arrow">──▶</span> 3 CSVs
           <span class="flow-arrow">──▶</span> Script 12: Reverse causation sensitivity
           <span class="flow-arrow">──▶</span> Upstream:  DAG models, PCA, Exam 6 outcomes, pspline
                </div>
            </section>

            <div class="section-sep"></div>

            <!-- 6. PIPELINE SCRIPTS -->
            <section id="pipeline">
                <h2 class="section-title">6. Pipeline Scripts (R code/)</h2>
                <p style="margin-bottom: 20px; color: #4b5563;">8 modular scripts representing the intended execution order for the published analysis.</p>

                <div class="dir-label">R code/ -- Final Pipeline</div>

                <div class="script-card"><div class="script-card-header"><h4>01_mesa_mortality (import, clean).R</h4><div class="script-meta"><span>205 lines</span><span>7.4 KB</span><span>Data Import</span></div></div><div class="script-card-body"><div class="script-purpose">Imports MESA exams and sleep data; recodes all sociodemographic covariates.</div><ul class="script-details"><li><strong>Data imports:</strong> 6 MESA exam DTA files, PSG, actigraphy, sleep questionnaire via <code>foreign::read.dta()</code></li><li><strong>Merge:</strong> Sequential <code>merge()</code> by <code>idno</code>: mesa_5 + PSG + actigraphy + sleep questionnaire</li><li><strong>Covariates:</strong> female, race (4-level), degree_attain (4-level from Exam 1), income (midpoint of 15 bins, tertiled), married, cesd_nosleep (CES-D minus sleep item), pack_years, modvig_pa, bmi, smoke</li></ul><div class="script-result"><strong>Output:</strong> <code>mesa_df</code> -- master merged data frame.</div></div></div>

                <div class="script-card"><div class="script-card-header"><h4>02_mesa_mortality (sleep, composites).R</h4><div class="script-meta"><span>~450 lines</span><span>16.5 KB</span><span class="model-tag primary">CLUSTERING + PCA</span></div></div><div class="script-card-body"><div class="script-purpose">Constructs all sleep variables, composite scores, performs sparse k-means clustering, and validates cluster solutions.</div><ul class="script-details"><li><strong>Seed:</strong> <code>set.seed(8675309)</code></li><li><strong>30+ features engineered</strong> from actigraphy (TST, SME, MPSD, frag, SDTST), questionnaire (ESS), and PSG (SWS%, REM%, AHI)</li><li><strong>13 dichotomized metrics</strong> using clinical cutoffs (TST 6-8hr, SME &gt;90%, MPSD &lt;30min, SDTST &lt;60min, etc.)</li><li><strong>Timing:</strong> Circular variable coding for sleep midpoint; log-transformed absolute deviation from median</li><li><strong>PCA:</strong> <code>prcomp(scale(13 metrics * -1))</code> -- higher = better; PC1 = continuous sleep health score</li><li><strong>SHS:</strong> 13-item binary sum score (0-13)</li><li><strong>Cluster validation:</strong> Gap statistic (B=60), NbClust (30 indices), cStability (1,000 bootstrap, k=2-10)</li><li><strong>Sparse K-means:</strong> <code>sparcl::KMeansSparseCluster(K=2)</code> with 250-permutation wbound selection</li><li><strong>Events merge:</strong> MESAEvThru2018 (mortality/CVD) + MESANonCVDEvThru2018 (cancer/COPD)</li></ul><div class="script-result"><strong>Output:</strong> <code>mesa_df</code> with cluster_f (783 Irregular-insufficient vs 1,046 Regular-optimal), pc1_scaled, shs, and all dichotomized indicators.</div></div></div>

                <div class="script-card"><div class="script-card-header"><h4>03_mesa_mortality (diet, other covariates, analytic df).R</h4><div class="script-meta"><span>~190 lines</span><span>7.4 KB</span><span>Diet Scoring</span></div></div><div class="script-card-body"><div class="script-purpose">Constructs AEHI-10 dietary composite from Exam 5 FFQ and nutrient data.</div><ul class="script-details"><li><strong>10 component scores</strong> (each 0-10): vegetables, fruit, whole grain (sex-specific), legumes, meat, transfat, longchain fatty acids, PUFA, sodium, alcohol (sex-specific)</li></ul><div class="script-result"><strong>Output:</strong> <code>aehi_df</code> -- AEHI-10 composite + 10 component scores.</div></div></div>

                <div class="script-card"><div class="script-card-header"><h4>04_mesa_mortality (shs_df - analytical dataset).R</h4><div class="script-meta"><span>~120 lines</span><span>4.6 KB</span><span>Dataset Assembly</span></div></div><div class="script-card-body"><div class="script-purpose">Assembles final analytical dataset: three-way merge, time-to-event variables, prevalent disease flags.</div><ul class="script-details"><li><strong>Three-way merge:</strong> mesa_subset_df + aehi_df + mesa_all_events</li><li><strong>Prevalent disease flags:</strong> prev_cvd, prev_cancer, prev_copd (event time &le; sleep exam time)</li><li><strong>Variable labels:</strong> <code>labelled::set_variable_labels()</code> for publication-ready output</li></ul><div class="script-result"><strong>Output:</strong> <code>shs_df</code> -- N = 1,726, 171 deaths.</div></div></div>

                <div class="script-card"><div class="script-card-header"><h4>05_mesa_clusters vs individual components.R</h4><div class="script-meta"><span>203 lines</span><span>7.2 KB</span><span class="model-tag primary">CORE ANALYSIS</span></div></div><div class="script-card-body"><div class="script-purpose">Head-to-head comparison of cluster-based vs. individual sleep metrics for mortality prediction.</div><ul class="script-details"><li><strong>4 Cox models:</strong> Cluster HR 0.52, SDTST HR 0.61, MPSD HR 0.64, TST HR 0.73</li><li><strong>Automated loop:</strong> Iterates all 4 predictors; builds standardized report table</li><li><strong>Forest plot + density plots:</strong> Exported as PNGs</li></ul><div class="script-result"><strong>Key Result:</strong> Cluster classification (HR 0.52) outperformed every individual metric (HRs 0.61-0.73).</div></div></div>

                <div class="script-card"><div class="script-card-header"><h4>06_mesa_mortality_cluster_survplots.R</h4><div class="script-meta"><span>~120 lines</span><span>4.7 KB</span><span>Visualization</span></div></div><div class="script-card-body"><div class="script-purpose">Kaplan-Meier and adjusted survival curves for clusters and individual metrics.</div><ul class="script-details"><li><strong>4 unadjusted KM curves:</strong> cluster_f, mpsd_di, sdtst_di, tst_di -- with CIs and risk tables</li><li><strong>Adjusted curves:</strong> <code>ggadjustedcurves()</code> conditional method with full covariate Cox model</li></ul><div class="script-result"><strong>Output:</strong> 5 publication-quality PNGs.</div></div></div>

                <div class="script-card"><div class="script-card-header"><h4>07_Cluster Propensity Score matching (MESA).R</h4><div class="script-meta"><span>342 lines</span><span>12.8 KB</span><span class="model-tag psm">PROPENSITY SCORE</span></div></div><div class="script-card-body"><div class="script-purpose">Full propensity score analysis: matching, IPTW, balance diagnostics, matched Cox models, bootstrap CIs.</div><ul class="script-details"><li><strong>Primary matching:</strong> Full matching, probit link, ATE estimand, caliper=0.2</li><li><strong>Kitchen sink:</strong> Adds BMI, medications, HTN, DM, CES-D, AHI</li><li><strong>Balance:</strong> Love plots (SMD &lt; 0.1)</li><li><strong>5 matched Cox models</strong> + IPTW + doubly-robust + bootstrap CIs (R=999)</li></ul></div></div>

                <div class="script-card"><div class="script-card-header"><h4>08_mesa_cluster_tables.R</h4><div class="script-meta"><span>72 lines</span><span>2.6 KB</span><span>Descriptive Stats</span></div></div><div class="script-card-body"><div class="script-purpose">TableOne descriptive statistics stratified by cluster and PC1 tertiles.</div><div class="script-result"><strong>Output:</strong> 3 CSVs: overall, stratified by cluster, supplemental by PC1 tertiles.</div></div></div>
            </section>

            <div class="section-sep"></div>

            <!-- 7. UPSTREAM SCRIPTS -->
            <section id="upstream">
                <h2 class="section-title">7. Upstream Scripts (Upstream/)</h2>
                <p style="margin-bottom: 20px; color: #4b5563;">Development and exploration scripts containing earlier versions, extended analyses, and sensitivity checks.</p>

                <details>
                    <summary style="cursor: pointer; color: #006400; font-weight: 600; padding: 10px; background: #f0fdf4; border-radius: 8px; margin-bottom: 15px;">9 upstream scripts -- click to expand</summary>

                    <div class="dir-label">Upstream/ -- Development &amp; Exploration</div>

                    <div class="script-card"><div class="script-card-header"><h4>10_CLUSTER REGRESSIONS.R</h4><div class="script-meta"><span>138 lines</span><span class="model-tag primary">DAG-BASED MODELS</span></div></div><div class="script-card-body"><div class="script-purpose">DAG-informed progressive Cox models (Models 0-5).</div><div class="script-result">Model 1: HR 0.56 | Model 2: HR 0.55 | Model 3: HR 0.56 | Model 4: HR 0.58 -- remarkably stable.</div></div></div>

                    <div class="script-card"><div class="script-card-header"><h4>Models 11_14_2022.R</h4><div class="script-meta"><span>570 lines</span><span class="model-tag primary">COMPREHENSIVE FINAL</span></div></div><div class="script-card-body"><div class="script-purpose">Most comprehensive script: 4 Cox + 5 PS matched + age metric + individual metrics. N=1,759; 176 deaths.</div></div></div>

                    <div class="script-card"><div class="script-card-header"><h4>Matching R script.R</h4><div class="script-meta"><span>322 lines</span><span class="model-tag psm">PSM VARIANT</span></div></div><div class="script-card-body"><div class="script-purpose">Earlier PSM version with sleep disorders in primary matching model.</div></div></div>

                    <div class="script-card"><div class="script-card-header"><h4>2022_nested_with_sleep.R</h4><div class="script-meta"><span>281 lines</span></div></div><div class="script-card-body"><div class="script-purpose">Extended: Exam 6 outcomes, insomnia/chronotype associations, regularity PCA, pspline sensitivity.</div></div></div>

                    <div class="script-card"><div class="script-card-header"><h4>2022_MESA_sensitivity.R</h4><div class="script-meta"><span>66 lines</span><span class="model-tag sensitivity">SENSITIVITY</span></div></div><div class="script-card-body"><div class="script-purpose">Replicates Script 05 on <code>shs_df</code> with reverse-coded indicators.</div></div></div>

                    <div class="script-card"><div class="script-card-header"><h4>ALL MODELS.R</h4><div class="script-meta"><span>78 lines</span></div></div><div class="script-card-body"><div class="script-purpose">Master reference of all model results -- single "source of truth" for reported HRs.</div></div></div>

                    <div class="script-card"><div class="script-card-header"><h4>Metric distributions (Clusters x Mortality).R</h4><div class="script-meta"><span>116 lines</span></div></div><div class="script-card-body"><div class="script-purpose">Density plots of sleep and disorder metrics by cluster with median overlays.</div></div></div>

                    <div class="script-card"><div class="script-card-header"><h4>Central Illustration.R + actigram idnos.R</h4><div class="script-meta"><span>161 lines</span></div></div><div class="script-card-body"><div class="script-purpose">Actigram visualizations: ideal archetype and real MESA participant sleep patterns by work schedule.</div></div></div>

                    <div class="script-card"><div class="script-card-header"><h4>2x2 cluster comparisons.R + SME seminar.R</h4><div class="script-meta"><span>151 lines</span></div></div><div class="script-card-body"><div class="script-purpose">Cross-tabs, scatter plots, WASO adjustment, no-disease subset, pspline models.</div></div></div>
                </details>
            </section>

            <div class="section-sep"></div>

            <!-- 8. ROOT SCRIPTS -->
            <section id="root">
                <h2 class="section-title">8. Root Scripts</h2>

                <div class="script-card"><div class="script-card-header"><h4>MESA sleep cluster code.R</h4><div class="script-meta"><span>~160 lines</span><span>5.9 KB</span><span class="model-tag primary">CLUSTER VALIDATION</span></div></div><div class="script-card-body"><div class="script-purpose">Standalone cluster validation: WSS elbow, gap statistic, NbClust, cStability, Jaccard bootstrap, sparse k-means.</div><ul class="script-details"><li>WSS elbow plot (k=1-15), gap statistic (B=60), NbClust (all indices), cStability (1,000 bootstrap), clusterboot Jaccard (k=2 vs k=3)</li><li>All converge on k=2; exported as TIFF diagnostic plots</li></ul></div></div>

                <div class="script-card"><div class="script-card-header"><h4>12 - mesa_mortality sensitvity (exclude 18 deaths).R</h4><div class="script-meta"><span>54 lines</span><span class="model-tag sensitivity">REVERSE CAUSATION</span></div></div><div class="script-card-body"><div class="script-purpose">Excludes 18 deaths within 1 year. N=1,740, 157 events.</div><div class="script-result">HR range 0.57-0.62 across models; age metric HR 0.71 [0.51, 0.99]. All significant -- reverse causation ruled out.</div></div></div>
            </section>

            <div class="section-sep"></div>

            <!-- 9. METHODS INVENTORY -->
            <section id="methods">
                <h2 class="section-title">9. Statistical Methods Inventory</h2>

                <details>
                    <summary style="cursor: pointer; color: #006400; font-weight: 600; padding: 10px; background: #f0fdf4; border-radius: 8px;">Full methods table -- click to expand</summary>
                    <table>
                        <tr><th>Method</th><th>Implementation</th><th>Purpose</th></tr>
                        <tr><td><strong>Cox Proportional Hazards</strong></td><td><code>survival::coxph()</code></td><td>Primary: cluster/metric association with mortality</td></tr>
                        <tr><td><strong>Propensity Score Matching</strong></td><td><code>MatchIt::matchit()</code></td><td>Full matching, probit, ATE, caliper=0.2</td></tr>
                        <tr><td><strong>IPTW</strong></td><td>Manual: <code>1/distance</code></td><td>Alternative causal inference</td></tr>
                        <tr><td><strong>Balance Diagnostics</strong></td><td><code>cobalt::love.plot()</code></td><td>SMD plots; threshold 0.1</td></tr>
                        <tr><td><strong>Bootstrap CIs</strong></td><td><code>boot::censboot()</code></td><td>R=999, log-logistic, BCA</td></tr>
                        <tr><td><strong>Sparse K-Means</strong></td><td><code>sparcl::KMeansSparseCluster()</code></td><td>Feature-weighted unsupervised clustering</td></tr>
                        <tr><td><strong>Gap Statistic</strong></td><td><code>cluster::clusGap()</code></td><td>Optimal k with B=60 bootstrap</td></tr>
                        <tr><td><strong>NbClust</strong></td><td><code>NbClust::NbClust()</code></td><td>30-index majority rule for k</td></tr>
                        <tr><td><strong>Cluster Stability</strong></td><td><code>cstab::cStability()</code></td><td>1,000 bootstrap, normalized instability</td></tr>
                        <tr><td><strong>Jaccard Bootstrap</strong></td><td><code>fpc::clusterboot()</code></td><td>Cluster recovery rates for k=2,3</td></tr>
                        <tr><td><strong>PCA</strong></td><td><code>prcomp()</code>, <code>factoextra</code></td><td>SHS-PC1 composite; regularity PCA</td></tr>
                        <tr><td><strong>Penalized Splines</strong></td><td><code>survival::pspline()</code></td><td>Nonlinear confounding sensitivity</td></tr>
                        <tr><td><strong>Kaplan-Meier</strong></td><td><code>survminer::ggsurvplot()</code></td><td>Unadjusted survival curves</td></tr>
                        <tr><td><strong>Adjusted Curves</strong></td><td><code>survminer::ggadjustedcurves()</code></td><td>Conditional method, full covariate model</td></tr>
                        <tr><td><strong>TableOne</strong></td><td><code>tableone::CreateTableOne()</code></td><td>Descriptives by cluster and PC1 tertiles</td></tr>
                        <tr><td><strong>AEHI-10</strong></td><td>Custom coding</td><td>10-component dietary quality, sex-specific</td></tr>
                    </table>
                </details>
            </section>

            <div class="section-sep"></div>

            <!-- 10. PACKAGES -->
            <section id="packages">
                <h2 class="section-title">10. R Package Dependencies</h2>

                <details>
                    <summary style="cursor: pointer; color: #006400; font-weight: 600; padding: 10px; background: #f0fdf4; border-radius: 8px;">22 packages -- click to expand</summary>
                    <table>
                        <tr><th>Package</th><th>Purpose</th><th>Key Functions</th></tr>
                        <tr><td><code>survival</code></td><td>Cox PH, survival objects</td><td><code>coxph()</code>, <code>Surv()</code>, <code>pspline()</code></td></tr>
                        <tr><td><code>survminer</code></td><td>Survival plots</td><td><code>ggsurvplot()</code>, <code>ggadjustedcurves()</code></td></tr>
                        <tr><td><code>MatchIt</code></td><td>PS matching</td><td><code>matchit()</code>, <code>match.data()</code></td></tr>
                        <tr><td><code>cobalt</code></td><td>Balance diagnostics</td><td><code>love.plot()</code></td></tr>
                        <tr><td><code>boot</code></td><td>Bootstrap inference</td><td><code>censboot()</code>, <code>boot.ci()</code></td></tr>
                        <tr><td><code>sparcl</code></td><td>Sparse K-means</td><td><code>KMeansSparseCluster()</code></td></tr>
                        <tr><td><code>cluster</code></td><td>Gap statistic</td><td><code>clusGap()</code></td></tr>
                        <tr><td><code>NbClust</code></td><td>Optimal k (30 indices)</td><td><code>NbClust()</code></td></tr>
                        <tr><td><code>cstab</code></td><td>Cluster stability</td><td><code>cStability()</code></td></tr>
                        <tr><td><code>fpc</code></td><td>Jaccard bootstrap</td><td><code>clusterboot()</code></td></tr>
                        <tr><td><code>tableone</code></td><td>Descriptive tables</td><td><code>CreateTableOne()</code></td></tr>
                        <tr><td><code>rms</code></td><td>Regression strategies</td><td><code>ShowRegTable()</code></td></tr>
                        <tr><td><code>factoextra</code></td><td>PCA visualization</td><td><code>fviz_eig()</code>, <code>fviz_pca_var()</code></td></tr>
                        <tr><td><code>ggplot2</code></td><td>Visualization</td><td><code>geom_density()</code>, <code>geom_errorbar()</code></td></tr>
                        <tr><td><code>ggpubr</code></td><td>Plot export</td><td><code>ggexport()</code></td></tr>
                        <tr><td><code>gridExtra</code></td><td>Multi-panel layout</td><td><code>grid.arrange()</code></td></tr>
                        <tr><td><code>dplyr</code> / <code>tidyverse</code></td><td>Data manipulation</td><td><code>select()</code>, <code>mutate()</code>, <code>filter()</code></td></tr>
                        <tr><td><code>haven</code> / <code>foreign</code></td><td>Stata import</td><td><code>read_dta()</code>, <code>read.dta()</code></td></tr>
                        <tr><td><code>hms</code></td><td>Time/HMS conversion</td><td><code>as.hms()</code></td></tr>
                        <tr><td><code>naniar</code></td><td>Missing data viz</td><td><code>gg_miss_var()</code></td></tr>
                        <tr><td><code>labelled</code></td><td>Variable labels</td><td><code>set_variable_labels()</code></td></tr>
                        <tr><td><code>ragg</code></td><td>TIFF export</td><td><code>agg_tiff()</code></td></tr>
                    </table>
                </details>
            </section>

            <div class="section-sep"></div>

            <!-- 11. CODE REVIEW -->
            <section id="issues">
                <h2 class="section-title">11. Code Review: Issues &amp; Recommendations</h2>

                <details>
                    <summary style="cursor: pointer; color: #006400; font-weight: 600; padding: 10px; background: #f0fdf4; border-radius: 8px;">Issues found during review -- click to expand</summary>

                    <div class="issue-card severity-high"><span class="issue-severity">HIGH</span><div class="issue-title">Variable Name Overwrite Bug in PS Matching</div><div class="issue-location">Models 11_14_2022.R, Line 217</div><p style="margin-top: 8px;">PS Model 4 assigned to <code>model_3_ps_out</code> (overwriting Model 3). Copy-paste error.</p></div>

                    <div class="issue-card severity-high"><span class="issue-severity">HIGH</span><div class="issue-title">Corrupted Files in Working Copy</div><div class="issue-location">R code/02, 03, 04, 06 + MESA sleep cluster code.R</div><p style="margin-top: 8px;">5 scripts are null bytes in the working copy. Valid copies exist in Samsung T7 backup. This review used the recovered backups.</p></div>

                    <div class="issue-card severity-high"><span class="issue-severity">HIGH</span><div class="issue-title">Hardcoded File Paths</div><div class="issue-location">01_mesa_mortality.R</div><p style="margin-top: 8px;">Multiple <code>setwd()</code> calls for different machines. Recommend <code>here::here()</code>.</p></div>

                    <div class="issue-card severity-medium"><span class="issue-severity">MEDIUM</span><div class="issue-title">No PH Assumption Testing</div><div class="issue-location">All Cox model scripts</div><p style="margin-top: 8px;">No <code>cox.zph()</code> or Schoenfeld residual plots found.</p></div>

                    <div class="issue-card severity-medium"><span class="issue-severity">MEDIUM</span><div class="issue-title">Inconsistent Dataset Names</div><div class="issue-location">Multiple scripts</div><p style="margin-top: 8px;"><code>shs_df</code>, <code>sueno_df</code>, <code>cluster_df</code>, <code>clusters_df</code> used inconsistently.</p></div>

                    <div class="issue-card severity-medium"><span class="issue-severity">MEDIUM</span><div class="issue-title">Complete Case Analysis Without Missingness Assessment</div><div class="issue-location">04_mesa_mortality.R</div><p style="margin-top: 8px;">~55 cases dropped (~3%) with no formal comparison or multiple imputation.</p></div>

                    <div class="issue-card severity-low"><span class="issue-severity">LOW</span><div class="issue-title">View() Calls, Unused Imports, 360 vs 365 Year Conversion</div><div class="issue-location">01_mesa_mortality.R, 04_mesa_mortality.R</div><p style="margin-top: 8px;">Minor cleanup items that don't affect results.</p></div>
                </details>
            </section>

        </div>

        <footer>
            <p><strong>Sleep Clusters &amp; All-Cause Mortality</strong> | MESA Cohort Analysis (2022)</p>
            <p>17 R scripts | 2,500+ lines | Joon Chung, PhD | University of Miami, Miller School of Medicine</p>
            <p style="margin-top: 10px; font-size: 0.85em; opacity: 0.7;">
                Generated by Claude Code (claude-opus-4-6)
            </p>
        </footer>

    </div>
</body>
</html>
